#include <genesis.h>
#include "main.h"
#include "gfx.h"
#include "Variables.h"
#include "Routines.h"
#include "dma.h"
#include "Sprites.h"
#include "Sound.h"
#include "Init.h"
#include "Animations.h"
#include "GestionPAD.h"


////////////////////////////////////////
//                  Gestion PAD
////////////////////////////////////////
void GestionPAD()
{
    // Phase scene en cours ? On quitte !
    if (PhaseScene ||GameOver) return;

    u16 value=JOY_readJoypad(JOY_1);

    // Init Joueur
    Sprite1_* spr=Sprites;
	spr = &Sprites[0];
    spr->Direction=0;
    spr->DirectionTir=0;
    spr->Sprint=0;
    spr->Boost=FIX32(0);

    // Saut joueur & Sprint
    if (!spr->Saut)
    {
        // Sprint joueur ?
        if (value & BUTTON_C)
        {
            spr->Boost=FIX32(1);
            spr->Sprint=1;
            spr->MemSprint=1;
        }

        // Saut ?
        if (value & BUTTON_B)
        {
            if (!spr->Saut && !spr->Feu)
            {
                if (spr->MemSprint) spr->Boost=FIX32(2);
                spr->Saut=1;
                spr->Acceleration=FIX32(6);
                spr->RefY=spr->CoordY;
                spr->SensY=1;
            }
        }
    }
    // Déplacement
    if (value & BUTTON_UP) spr->Direction=0;
    if (value & BUTTON_DOWN) spr->Direction=2;

    if (value & BUTTON_RIGHT)
    {
        if (spr->Direction==2) spr->Direction=26;
        else spr->Direction=6;
        if (spr->Feu==1 && spr->MemDir==4)
        {
            if (spr->Direction==2) spr->Direction=26;
            else spr->Direction=0;
        }
    }
    else if (value & BUTTON_LEFT)
    {
        if (spr->Direction==2) spr->Direction=24;
        else spr->Direction=4;
        if (spr->Feu==1 && spr->MemDir==6)
        {
            if (spr->Direction==2) spr->Direction=26;
            else spr->Direction=0;
        }
    }

    // Tir ?! On ne tire par en marchant accroupi.
    if (spr->Direction!=26 && spr->Direction!=24 )
    {
        if (value & BUTTON_A && !spr->Feu)
        {
            spr->Feu=1;
            // Test Collision couteau ?
            if (!spr->Saut)
            {
                u16 NbrIA=NombreIA;
                Sprite1_* SprIA=Sprites;
                SprIA=&Sprites[IDUnite];
                while(NbrIA--)
                {
                    if (!SprIA->StandBy && SprIA->Visible && !SprIA->MortIA)
                    {
                        if (spr->MemDir==6 || !spr->MemDir || spr->Direction==6)
                        {
                            fix32 DX_IA=abs(spr->CoordX - SprIA->CoordX);
                            if (DX_IA<=FIX32(32) && (spr->CoordX<SprIA->CoordX))
                            {
                                spr->Couteau=1;
                                spr->TempoCouteau=0;
                                SND_startPlayPCM_XGM(SFX_GENERIC4, 1, SOUND_PCM_CH3);
                                break;
                            }
                        }
                        if (spr->MemDir==4 || spr->Direction==4)
                        {
                            fix32 DX_IA=abs(spr->CoordX - SprIA->CoordX);
                            if (DX_IA<=FIX32(40) && (spr->CoordX>=SprIA->CoordX))
                            {
                                spr->Couteau=1;
                                spr->TempoCouteau=0;
                                SND_startPlayPCM_XGM(SFX_GENERIC4, 1, SOUND_PCM_CH3);
                                break;
                            }
                        }
                    }
                    SprIA++;
                }
            }

            // Tir au pistolet ?
            if (!spr->Couteau)
            {
                u16 i=NombreBalle,j=0;
                Sprite1_* spr1=Sprites;
                spr1 = &Sprites[IDBalle];
                while(i--)
                {
                    spr1 = &Sprites[Nb+j];
                    if (spr1->StandBy)
                    {
                        spr1->StandBy=0;
                        spr->TempoRafale=0;
                        spr1->ID=45;
                        spr1->Hit=0;
                        SND_startPlayPCM_XGM(SFX_GENERIC1, 1, SOUND_PCM_CH3);
                        SPR_setAnim(spr1->SpriteA,0);
                        spr1->Visible=1;
                        spr1->Vitesse=FIX32(8);
                        spr1->CoordX=spr->CoordX;
                        spr1->CoordY=spr->CoordY+spr->DeltaY;
                        spr1->OffsetY=FIX32(-7);
                        spr1->Direction=spr->MemDir;
                        if (!spr->MemDir) spr1->Direction=6;
                        if (spr->Direction==26 || spr->Direction==24 || spr->Direction==2) spr1->OffsetY=FIX32(-17);
                        break;
                    }
                    j++;
                }
            }
        }
    }

    // Mémorisation direction joueur
    if (spr->Direction!=0 && spr->Direction!=2 && spr->Direction!=8)
    {
        spr->MemDir=spr->Direction;
        if (spr->MemDir==24) spr->MemDir=4;
        if (spr->MemDir==26) spr->MemDir=6;
    }

}
